import { video } from './video.js';
import { image } from './image.js';
import { audio } from './audio.js';
import { progress } from './progress.js';
import { util } from '../../common/util.js';
import { bs } from '../../libs/bootstrap.js';
import { loader } from '../../libs/loader.js';
import { theme } from '../../common/theme.js';
import { lang } from '../../common/language.js';
import { storage } from '../../common/storage.js';
import { session } from '../../common/session.js';
import { offline } from '../../common/offline.js';
import * as confetti from '../../libs/confetti.js';
import { pool } from '../../connection/request.js';

export const guest = (() => {
  /**
   * @type {ReturnType<typeof storage>|null}
   */
  let information = null;

  /**
   * @type {ReturnType<typeof storage>|null}
   */
  let config = null;

  /**
   * @returns {void}
   */
  const countDownDate = () => {
    const count = new Date(
      document.body.getAttribute('data-time').replace(' ', 'T')
    ).getTime();

    /**
     * @param {number} num
     * @returns {string}
     */
    const pad = (num) => (num < 10 ? `0${num}` : `${num}`);

    const day = document.getElementById('day');
    const hour = document.getElementById('hour');
    const minute = document.getElementById('minute');
    const second = document.getElementById('second');

    const updateCountdown = () => {
      const distance = Math.abs(count - Date.now());

      day.textContent = pad(Math.floor(distance / (1000 * 60 * 60 * 24)));
      hour.textContent = pad(
        Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
      );
      minute.textContent = pad(
        Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))
      );
      second.textContent = pad(Math.floor((distance % (1000 * 60)) / 1000));

      util.timeOut(updateCountdown, 1000 - (Date.now() % 1000));
    };

    util.timeOut(updateCountdown);
  };

  /**
   * @returns {void}
   */
  const showGuestName = () => {
    /**
     * Make sure "to=" is the last query string.
     * Ex. ulems.my.id/?id=some-uuid-here&to=name
     */
    const raw = window.location.search.split('to=');
    let name = null;

    if (raw.length > 1 && raw[1].length >= 1) {
      name = window.decodeURIComponent(raw[1]);
    }

    if (name) {
      const guestName = document.getElementById('guest-name');
      const div = document.createElement('div');
      div.classList.add('m-2');

      const template = `<small class="mt-0 mb-1 mx-0 p-0">${util.escapeHtml(
        guestName?.getAttribute('data-message')
      )}</small><p class="m-0 p-0" style="font-size: 1.25rem">${util.escapeHtml(
        name
      )}</p>`;
      util.safeInnerHTML(div, template);

      guestName?.appendChild(div);
    }

    const form = document.getElementById('form-name');
    if (form) {
      form.value = information.get('name') ?? name;
    }
  };

  /**
   * @returns {Promise<void>}
   */
  const slide = async () => {
    const interval = 6000;
    const slides = document.querySelectorAll('.slide-desktop');

    if (!slides || slides.length === 0) {
      return;
    }

    const desktopEl = document
      .getElementById('root')
      ?.querySelector('.d-sm-block');
    if (!desktopEl) {
      return;
    }

    desktopEl.dispatchEvent(new Event('undangan.slide.stop'));

    if (window.getComputedStyle(desktopEl).display === 'none') {
      return;
    }

    if (slides.length === 1) {
      await util.changeOpacity(slides[0], true);
      return;
    }

    let index = 0;
    for (const [i, s] of slides.entries()) {
      if (i === index) {
        s.classList.add('slide-desktop-active');
        await util.changeOpacity(s, true);
        break;
      }
    }

    let run = true;
    const nextSlide = async () => {
      await util.changeOpacity(slides[index], false);
      slides[index].classList.remove('slide-desktop-active');

      index = (index + 1) % slides.length;

      if (run) {
        slides[index].classList.add('slide-desktop-active');
        await util.changeOpacity(slides[index], true);
      }

      return run;
    };

    desktopEl.addEventListener('undangan.slide.stop', () => {
      run = false;
    });

    const loop = async () => {
      if (await nextSlide()) {
        util.timeOut(loop, interval);
      }
    };

    util.timeOut(loop, interval);
  };

  /**
   * @param {HTMLButtonElement} button
   * @returns {void}
   */
  const open = (button) => {
    button.disabled = true;
    document.body.scrollIntoView({ behavior: 'instant' });
    document.getElementById('root').classList.remove('opacity-0');

    if (theme.isAutoMode()) {
      document.getElementById('button-theme').classList.remove('d-none');
    }

    slide();
    theme.spyTop();

    confetti.basicAnimation();
    util.timeOut(confetti.openAnimation, 1500);

    document.dispatchEvent(new Event('undangan.open'));
    util
      .changeOpacity(document.getElementById('welcome'), false)
      .then((el) => el.remove());
  };

  /**
   * @param {HTMLImageElement} img
   * @returns {void}
   */
  const modal = (img) => {
    document.getElementById('button-modal-click').setAttribute('href', img.src);
    document
      .getElementById('button-modal-download')
      .setAttribute('data-src', img.src);

    const i = document.getElementById('show-modal-image');
    i.src = img.src;
    i.width = img.width;
    i.height = img.height;
    bs.modal('modal-image').show();
  };

  /**
   * @returns {void}
   */
  const modalImageClick = () => {
    document
      .getElementById('show-modal-image')
      .addEventListener('click', (e) => {
        const abs =
          e.currentTarget.parentNode.querySelector('.position-absolute');

        abs.classList.contains('d-none')
          ? abs.classList.replace('d-none', 'd-flex')
          : abs.classList.replace('d-flex', 'd-none');
      });
  };

  /**
   * @param {HTMLDivElement} div
   * @returns {void}
   */
  const showStory = (div) => {
    if (navigator.vibrate) {
      navigator.vibrate(500);
    }

    confetti.tapTapAnimation(div, 100);
    util.changeOpacity(div, false).then((e) => e.remove());
  };

  /**
   * @returns {void}
   */
  const closeInformation = () => information.set('info', true);

  /**
   * @returns {void}
   */
  const normalizeArabicFont = () => {
    document.querySelectorAll('.font-arabic').forEach((el) => {
      el.innerHTML = String(el.innerHTML).normalize('NFC');
    });
  };

  /**
   * @returns {void}
   */
  const animateSvg = () => {
    document.querySelectorAll('svg').forEach((el) => {
      if (el.hasAttribute('data-class')) {
        util.timeOut(
          () => el.classList.add(el.getAttribute('data-class')),
          parseInt(el.getAttribute('data-time'))
        );
      }
    });
  };

  /**
   * @returns {void}
   */
  const buildGoogleCalendar = () => {
    /**
     * @param {string} d
     * @returns {string}
     */
    const formatDate = (d) =>
      new Date(d.replace(' ', 'T') + ':00Z')
        .toISOString()
        .replace(/[-:]/g, '')
        .split('.')
        .shift();

    const url = new URL('https://calendar.google.com/calendar/render');
    const data = new URLSearchParams({
      action: 'TEMPLATE',
      text: 'Lễ cưới Hữu Chinh & Thanh Trúc',
      dates: `${formatDate('2025-11-23 11:30')}/${formatDate(
        '2025-11-23 17:00'
      )}`,
      details:
        'Chúng tôi hân hạnh mời Quý vị đến chung vui trong ngày trọng đại của chúng tôi. Sự có mặt và lời chúc của Quý vị chính là món quà ý nghĩa nhất.',
      location: '5J8P+HC7, Thạnh Trị, Bình Đại, Bến Tre',
      ctz: config.get('vn'),
    });

    url.search = data.toString();
    document
      .querySelector('#home button')
      ?.addEventListener('click', () => window.open(url, '_blank'));
  };

  /**
   * @returns {object}
   */
  const loaderLibs = () => {
    progress.add();

    /**
     * @param {{aos: boolean, confetti: boolean}} opt
     * @returns {void}
     */
    const load = (opt) => {
      loader(opt)
        .then(() => progress.complete('libs'))
        .catch(() => progress.invalid('libs'));
    };

    return {
      load,
    };
  };

  /**
   * @returns {Promise<void>}
   */
  const booting = async () => {
    animateSvg();
    countDownDate();
    showGuestName();
    modalImageClick();
    normalizeArabicFont();
    buildGoogleCalendar();

    if (information.has('presence')) {
      document.getElementById('form-presence').value = information.get(
        'presence'
      )
        ? '1'
        : '2';
    }

    if (information.get('info')) {
      document.getElementById('information')?.remove();
    }

    // wait until welcome screen is show.
    await util.changeOpacity(document.getElementById('welcome'), true);

    // remove loading screen and show welcome screen.
    await util
      .changeOpacity(document.getElementById('loading'), false)
      .then((el) => el.remove());
  };

  /**
   * @returns {void}
   */
  const pageLoaded = () => {
    lang.init();
    offline.init();
    progress.init();

    config = storage('config');
    information = storage('information');

    const vid = video.init();
    const img = image.init();
    const aud = audio.init();
    const lib = loaderLibs();
    const token = document.body.getAttribute('data-key');

    window.addEventListener('resize', util.debounce(slide));
    document.addEventListener('undangan.progress.done', () => booting());
    document.addEventListener('hide.bs.modal', () =>
      document.activeElement?.blur()
    );
    document
      .getElementById('button-modal-download')
      .addEventListener('click', (e) => {
        img.download(e.currentTarget.getAttribute('data-src'));
      });

    if (!token || token.length <= 0) {
      document.getElementById('comment')?.remove();
      document
        .querySelector('a.nav-link[href="#comment"]')
        ?.closest('li.nav-item')
        ?.remove();

      vid.load();
      img.load();
      aud.load();
      lib.load({
        confetti: document.body.getAttribute('data-confetti') === 'true',
      });
    }

    if (token && token.length > 0) {
      // add 2 progress for config and comment.
      // before img.load();
      progress.add();
      progress.add();

      // if don't have data-src.
      if (!img.hasDataSrc()) {
        img.load();
      }

      document.dispatchEvent(new Event('undangan.session'));
      if (img.hasDataSrc()) {
        img.load();
      }

      vid.load();
      aud.load();
      lib.load({ confetti: true });
      progress.complete('config');
      progress.complete('comment');
    }
  };

  const bindingGuestName = async () => {
    // GuestId stand for UUID of the guest

    const query = window.location.search.replace('?', '').split('&');
    const guestId = query.find((q) => q.startsWith('g='))?.split('=')[1] || '1';

    const res = await fetch('./assets/guests/data.json');
    const guests = await res.json();
    const guestName = guests.find((g) => g.id === guestId);

    if (guestName) {
      const el = document.getElementById('guest-name');
      if (el) {
        el.innerHTML = guestName.name;
      }
    }
  };

  /**
   * @returns {object}
   */
  const init = () => {
    theme.init();
    session.init();

    if (session.isAdmin()) {
      storage('user').clear();
      storage('owns').clear();
      storage('likes').clear();
      storage('session').clear();
    }

    window.addEventListener('load', () => {
      pool.init(pageLoaded, ['image', 'video', 'audio', 'libs']);
    });

    bindingGuestName();

    return {
      util,
      theme,
      guest: {
        open,
        modal,
        showStory,
        closeInformation,
      },
    };
  };

  return {
    init,
  };
})();
